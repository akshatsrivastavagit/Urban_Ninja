

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Booking</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <h2>Selected Services:</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Duration</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in selected_services['services'] %}
                        <tr>
                            <td>{{ service['name'] }}</td>
                            <td>{{ service['price'] }}</td>
                            <td>{{ service['quantity'] }}</td>
                            <td>{{ service['duration'] }} minutes</td>
                            <td>{{ service['total'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4"><strong>Address:</strong></td>
                            <td>{{ selected_services['address'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Slot Date:</strong></td>
                            <td>{{ selected_services['slotdate'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Slot Time:</strong></td>
                            <td>{{ selected_services['slottime'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Phone number:</strong></td>
                            <td>{{ selected_services['phone'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Total Amount:</strong></td>
                            <td>{{ selected_services['total_amount'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Total Duration:</strong></td>
                            <td>{{ selected_services['total_duration'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Offer Name:</strong></td>
                            <td>{{ selected_services['offer_name'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Offer Discount:</strong></td>
                            <td>{{ selected_services['offer_discount'] }}%</></td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Discount Amount:</strong></td>
                            <td>{{ selected_services['discount_amt'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Discounted Total:</strong></td>
                            <td>{{ selected_services['discounted_total'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Credits Used:</strong></td>
                            <td>{{ selected_services['credits_used'] }}</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Final Amount:</strong></td>
                            <td>{{ selected_services['final_amount'] }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="col-md-6">
                
                <form id="addressForm" method="post" action="/payment_slot_booking/{{ session.get('sc_id','') }}">
                    <input type="hidden" name="purpose" value="addressDetails">
                    <div class="form-group">
                        <label for="cityName">Enter your address:</label>
                        <input type="text" class="form-control" id="cityName" name="address"  required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Enter your phone number:</label>
                        <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" required>
                        <small id="phoneHelp" class="form-text text-muted">Please enter a 10-digit phone number.</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Address</button>
                </form>
                <form id="slotForm" method="post" action="/payment_slot_booking/{{ session.get('sc_id') }}">
                    <input type="hidden" name="purpose" value="slotBooking">
                    <div class="form-group">
                        <h1>Select a Slot</h1>
                        <label for="slot_date">Choose a Date:</label>
                        <select name="slot_date" id="slot_date">
                            {% if available_slots %}
                                {% for date, slots in available_slots.items() %}
                                    <option value="{{ date }}">{{ date }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">We do not provide service at this location</option>
                            {% endif %}
                        </select>
                        
                        <label for="slot_time">Choose a Time:</label>
                        <select name="slot_time" id="slot_time">
                            <!-- Times will be dynamically populated based on the selected date -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Book Slot</button>
                </form>
                
                <!-- Verify Payment Form -->
                <form id="verifyPaymentForm" method="post" action="/payment_slot_booking/{{ session.get('sc_id','') }}">
                    <input type="hidden" name="purpose" value="verifyPayment">
                    <div class="form-group">
                        <h1>Verify Payment</h1>
                        <img src="{{ url_for('static', filename='images/qrcode.png') }}" alt="QR Code">
                        <label for="upiRefNo">Enter UPI Reference Number:</label>
                        <input type="text" class="form-control" id="upiRefNo" name="upiRefNo" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Verify Payment</button>
                </form>

                <!-- Display Payment Validity -->
                <!-- Display Payment Validity -->
                {% if selected_services.payment_validity %}
                <div class="mt-3">
                    <p>{{ selected_services.payment_validity }}</p>
                    {% if selected_services.payment_validity == 'VALID PAYMENT' %}
                        <form id="confirmBookingForm" action="/confirm_booking" method="post">
                            <input type="hidden" name="confirm_booking" value="true">
                            <button type="submit" class="btn btn-success">Confirm Booking</button>
                        </form>
                    {% else %}
                        <button type="button" class="btn btn-secondary" disabled>Confirm Booking</button>
                    {% endif %}
                </div>
                {% endif %}


            </div>
        </div>
    </div>

    <script>
        document.getElementById('confirmBookingForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        // Optionally, perform client-side validation here

        // Submit the form via AJAX
        fetch('/confirm_booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            // No body data needed here since the form doesn't have any fields
        })
        .then(response => response.json())
        .then(data => {
            console.log('Booking confirmed:', data);
            // Update the URL with the booking_id from the response
            window.location.href = '/bill/' + data.booking_id;
        })
        .catch(error => {
            console.error('Error confirming booking:', error);
            // Handle errors if needed
        });
    });

    </script>
    

    <!-- Bootstrap JS and dependencies (jQuery, Popper.js) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js" integrity="sha384-TzFuhjSb/Y4Gj2+xrRcoS7mKfYjTXsWfDUp1ibU09sz7p/MmLCX1yWCxJzQd9JAT" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-5A0hP1V0ODwKdeveVszWMob450VZxX7J0oKRrGARn5B+6q50akxF5EtFzSt5E7x" crossorigin="anonymous"></script>
    <script>
        function validateForm() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const phonePattern = /^\d{10}$/;
            if (!phonePattern.test(phoneNumber)) {
                alert('Please enter a valid 10-digit phone number.');
                return false;
            }
            return true;
        }

        const availableSlots = {{ available_slots|tojson }};
        const slotDateSelect = document.getElementById('slot_date');
        const slotTimeSelect = document.getElementById('slot_time');

        function populateTimes() {
            const selectedDate = slotDateSelect.value;
            const times = availableSlots[selectedDate] || [];
            slotTimeSelect.innerHTML = '';
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                slotTimeSelect.appendChild(option);
            });
        }

        slotDateSelect.addEventListener('change', populateTimes);
        window.addEventListener('load', populateTimes);
    </script>
</body>
</html>
